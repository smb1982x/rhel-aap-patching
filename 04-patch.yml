---
# JOB TEMPLATE NOTE:
# - Expects verify_success_hosts from previous workflow step
# - Extra vars: patch_strategy (optional: 'auto', 'conditional', 'package_only')

- name: Validate hosts available for patching
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check if verification produced any successful hosts
      fail:
        msg: "No hosts available for patching - verify_success_hosts is empty"
      when: verify_success_hosts | default([]) | length == 0

    - name: Create dynamic inventory group for patching with temp directory config
      add_host:
        hostname: "{{ item }}"
        groups: "patch_targets"
        # Set ansible_remote_tmp at host level for proper precedence
        ansible_remote_tmp: "/opt/ansible-temp/{{ ansible_user | default(ansible_ssh_user | default('ansible')) }}"
      loop: "{{ verify_success_hosts | default([]) }}"

- name: Prepare remote temp directory for Ansible operations
  hosts: patch_targets
  gather_facts: false
  become: true
  tasks:
    - name: Create Ansible temp base directory
      file:
        path: "/opt/ansible-temp"
        state: directory
        mode: '1777'  # Sticky bit + world writable
        owner: root
        group: root
      failed_when: false

    - name: Create user-specific temp directory
      file:
        path: "/opt/ansible-temp/{{ ansible_user | default(ansible_ssh_user | default('ansible')) }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user | default(ansible_ssh_user | default('ansible')) }}"
        group: "{{ ansible_user | default(ansible_ssh_user | default('ansible')) }}"
      failed_when: false

- name: Patch servers with specific repository control
  hosts: patch_targets
  gather_facts: true  # Need facts for OS version detection
  become: true
  vars:
    patch_async_timeout: "{{ patch_async_timeout | default(14400) }}"  # 4h
    patch_poll_interval: "{{ patch_poll_interval | default(60) }}"
    patch_strategy: "{{ patch_strategy | default('auto') }}"  # auto, conditional, package_only
  tasks:
    - name: Determine RHEL version and set repository list
      set_fact:
        rhel_repos: >-
          {%- if ansible_distribution_major_version | int in [6, 7] -%}
          ["rhel-7-server-els-optional-rpms", "rhel-7-server-els-rpms"]
          {%- elif ansible_distribution_major_version | int == 8 -%}
          ["rhel-8-for-x86_64-appstream-rpms", "rhel-8-for-x86_64-baseos-rpms"]
          {%- elif ansible_distribution_major_version | int == 9 -%}
          ["rhel-9-for-x86_64-baseos-rpms", "rhel-9-for-x86_64-appstream-rpms"]
          {%- else -%}
          []
          {%- endif -%}
        repo_args: >-
          {%- if ansible_distribution_major_version | int in [6, 7] -%}
          --disablerepo=* --enablerepo=rhel-7-server-els-optional-rpms --enablerepo=rhel-7-server-els-rpms
          {%- elif ansible_distribution_major_version | int == 8 -%}
          --disablerepo=* --enablerepo=rhel-8-for-x86_64-appstream-rpms --enablerepo=rhel-8-for-x86_64-baseos-rpms
          {%- elif ansible_distribution_major_version | int == 9 -%}
          --disablerepo=* --enablerepo=rhel-9-for-x86_64-baseos-rpms --enablerepo=rhel-9-for-x86_64-appstream-rpms
          {%- else -%}
          
          {%- endif -%}

    - name: Display detected system information
      debug:
        msg: |
          Host: {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Major Version: {{ ansible_distribution_major_version }}
          Package Manager: {{ ansible_facts.pkg_mgr | default('unknown') }}
          Strategy: {{ patch_strategy }}
          Temp Directory: {{ ansible_remote_tmp }}
          Repositories: {{ rhel_repos }}
          Repo Args: {{ repo_args }}

    - name: Ensure temp directory exists and is accessible
      file:
        path: "{{ ansible_remote_tmp }}"
        state: directory
        mode: '0755'
      failed_when: false

    - name: Fail if RHEL version is not supported
      fail:
        msg: "Unsupported RHEL version: {{ ansible_distribution_major_version }}. Only RHEL 6, 7, 8, and 9 are supported."
      when: ansible_distribution_major_version | int not in [6, 7, 8, 9]

    # Strategy 1: Use DNF with specific repositories (RHEL 8/9)
    - name: Start package update using DNF with specific repositories
      shell: "dnf update -y {{ repo_args }}"
      async: "{{ patch_async_timeout }}"
      poll: 0
      register: dnf_repo_async
      failed_when: false
      when:
        - patch_strategy in ['auto', 'conditional', 'package_only']
        - ansible_distribution_major_version | int in [8, 9]
        - ansible_facts.pkg_mgr in ['dnf']

    - name: Wait for DNF repository-specific update to finish
      async_status:
        jid: "{{ dnf_repo_async.ansible_job_id }}"
      register: dnf_repo_wait
      until: (dnf_repo_wait.finished | default(0)) | int == 1
      retries: "{{ (patch_async_timeout | int // patch_poll_interval | int) + 1 }}"
      delay: "{{ patch_poll_interval | int }}"
      failed_when: false
      when: dnf_repo_async is defined and dnf_repo_async.ansible_job_id is defined

    # Strategy 2: Use YUM with specific repositories (RHEL 6/7 or fallback)
    - name: Start package update using YUM with specific repositories
      shell: "yum update -y {{ repo_args }}"
      async: "{{ patch_async_timeout }}"
      poll: 0
      register: yum_repo_async
      failed_when: false
      when: >
        patch_strategy in ['auto', 'conditional', 'package_only'] and
        (
          ansible_distribution_major_version | int in [6, 7] or
          ansible_facts.pkg_mgr in ['yum'] or
          (dnf_repo_async is defined and dnf_repo_async.failed | default(false)) or
          (dnf_repo_wait is defined and dnf_repo_wait.failed | default(false))
        )

    - name: Wait for YUM repository-specific update to finish
      async_status:
        jid: "{{ yum_repo_async.ansible_job_id }}"
      register: yum_repo_wait
      until: (yum_repo_wait.finished | default(0)) | int == 1
      retries: "{{ (patch_async_timeout | int // patch_poll_interval | int) + 1 }}"
      delay: "{{ patch_poll_interval | int }}"
      failed_when: false
      when: yum_repo_async is defined and yum_repo_async.ansible_job_id is defined

    # Cleanup async job files
    - name: Cleanup async job files
      async_status:
        jid: "{{ item }}"
        mode: cleanup
      changed_when: false
      failed_when: false
      loop:
        - "{{ dnf_repo_async.ansible_job_id | default('') }}"
        - "{{ yum_repo_async.ansible_job_id | default('') }}"
      when: item != ''

    # Determine overall patch result
    - name: Calculate patch result
      set_fact:
        patch_result_status: >-
          {{
            (
              (dnf_repo_wait.finished | default(0)) | int == 1 and 
              not (dnf_repo_wait.failed | default(false)) and
              (dnf_repo_wait.rc | default(1)) == 0
            ) or (
              (yum_repo_wait.finished | default(0)) | int == 1 and 
              not (yum_repo_wait.failed | default(false)) and
              (yum_repo_wait.rc | default(1)) == 0
            )
          }}
        patch_method: >-
          {{
            'dnf' if (
              (dnf_repo_wait.finished | default(0)) | int == 1 and 
              not (dnf_repo_wait.failed | default(false)) and
              (dnf_repo_wait.rc | default(1)) == 0
            ) else 'yum'
          }}

    - name: Record successful patch results
      set_stats:
        data:
          patch_success_hosts: "{{ patch_success_hosts | default([]) + [inventory_hostname] }}"
          patch_method_map: >-
            {{
              patch_method_map | default({}) | combine({
                inventory_hostname: patch_method
              })
            }}
          patch_repos_used: >-
            {{
              patch_repos_used | default({}) | combine({
                inventory_hostname: rhel_repos
              })
            }}
        aggregate: true
        per_host: false
      when: patch_result_status | default(false)

    - name: Record failed patch results
      set_stats:
        data:
          patch_failed_hosts: "{{ patch_failed_hosts | default([]) + [inventory_hostname] }}"
          patch_failure_reasons: >-
            {{
              patch_failure_reasons | default({}) | combine({
                inventory_hostname: dnf_repo_wait.stderr | default(yum_repo_wait.stderr | default('Unknown patching error'))
              })
            }}
        aggregate: true
        per_host: false
      when: not (patch_result_status | default(false))

    - name: Display patch result for this host
      debug:
        msg: |
          Host: {{ inventory_hostname }}
          RHEL Version: {{ ansible_distribution_major_version }}
          Patch Status: {{ patch_result_status | default(false) | ternary('SUCCESS', 'FAILED') }}
          Method Used: {{ patch_method }}
          Repositories Used: {{ rhel_repos | join(', ') }}
          {% if not (patch_result_status | default(false)) %}
          Error: {{ dnf_repo_wait.stderr | default(yum_repo_wait.stderr | default('Unknown error')) }}
          {% endif %}

- name: Patch phase summary
  hosts: localhost
  gather_facts: false
  run_once: true
  tasks:
    - name: Display patching summary
      debug:
        msg: |
          ========================================
          PATCH PHASE COMPLETED
          ========================================
          Target Hosts: {{ verify_success_hosts | default([]) | length }}
          Successful: {{ ansible_stats.data.patch_success_hosts | default([]) | length }}
          Failed: {{ ansible_stats.data.patch_failed_hosts | default([]) | length }}
          Success Rate: {{ ((ansible_stats.data.patch_success_hosts | default([]) | length) * 100.0 / (verify_success_hosts | default([]) | length)) | round(1) }}%
          ========================================
          Successful Hosts: {{ ansible_stats.data.patch_success_hosts | default([]) | join(', ') }}
          Failed Hosts: {{ ansible_stats.data.patch_failed_hosts | default([]) | join(', ') }}
          ========================================
          Repository Usage Summary:
          {% for host in ansible_stats.data.patch_success_hosts | default([]) %}
          - {{ host }}: {{ ansible_stats.data.patch_repos_used[host] | default([]) | join(', ') }}
          {% endfor %}
          ========================================
